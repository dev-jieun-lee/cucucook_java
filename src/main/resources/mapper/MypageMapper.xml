<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.cucucook.mapper.MypageMapper">
    <!-- 회원이 쓴 글 갯수 -->
    <select id="getWriteCount" resultType="int">
        SELECT COUNT(*)
        FROM board
        WHERE member_id = #{memberId}
    </select>

    <!-- 회원이 쓴 댓글 갯수 -->
    <select id="getReplyCount" resultType="int">
        SELECT COUNT(*)
        FROM recipe_comment
        WHERE member_id = #{memberId}
    </select>

    <!-- 회원이 찜한 레시피 갯수 -->
    <select id="getLikeCount" resultType="int">
        SELECT COUNT(*)
        FROM recipe_like
        WHERE member_id = #{memberId}
    </select>

<!-- 회원이 쓴 글 목록 -->
<select id="getMemberBoardList" resultType="com.example.cucucook.domain.Board">
    SELECT *
    FROM board
    WHERE member_id = #{memberId}
    ORDER BY reg_dt DESC
    LIMIT #{display}
    OFFSET #{start}
</select>


    <!-- 회원이 쓴 댓글 목록 -->
    <select id="getRecipeCommentList" resultType="com.example.cucucook.domain.RecipeComment">
        SELECT *
        FROM recipe_comment
        WHERE memberId = #{memberId}
        ORDER BY created_at DESC
        LIMIT #{start}, #{display}
    </select>

    <!-- 회원 레시피 찜 목록 -->
    <select id="getRecipeLikeList" resultType="com.example.cucucook.domain.RecipeLike">
        SELECT *
        FROM recipe_like
        WHERE memberId = #{memberId}
        ORDER BY created_at DESC
        LIMIT #{start}, #{display}
    </select>

    <!-- 회원 레시피 찜 보기 -->
    <select id="getRecipeLike" resultType="com.example.cucucook.domain.RecipeLike">
        SELECT *
        FROM recipe_like
        WHERE memberId = #{memberId}
        AND recipeId = #{recipeId}
    </select>

    <!-- 회원 레시피 찜 추가 -->
    <insert id="insertRecipeLike">
        INSERT INTO recipe_like (memberId, recipeId)
        VALUES (#{recipeLike.memberId}, #{recipeLike.recipeId})
    </insert>

    <!-- 회원 레시피 찜 삭제 -->
    <delete id="deleteRecipeLike">
        DELETE FROM recipe_like
        WHERE memberId = #{memberId}
        AND recipeId = #{recipeId}
    </delete>

    <!-- 내가 쓴 댓글 조회 -->
    <select id="getMyComments" resultType="com.example.cucucook.domain.RecipeComment">
    SELECT rc.recipe_id
                ,  rc.comment_id
                ,  rc.member_id
                ,  rc.comment
                ,  rc.rate
                ,  rc.reg_dt
                ,  rc.upt_dt
                ,  rc.status
                ,  rc.p_comment_id
                ,  rc.del_yn
                , mr.title
            FROM recipe_comment rc
            LEFT JOIN member_recipe mr ON rc.recipe_id = mr.recipe_id
            WHERE rc.member_id = ${memberId}
                and del_yn = 'N'
            ORDER BY
        <choose>
            <when test="sortOption == 'recipeId'">
                rc.recipe_id ${sortDirection}
            </when>
            <when test="sortOption == 'regDt'">
                rc.reg_dt ${sortDirection}
            </when>
            <otherwise>
                rc.comment_id ${sortDirection}
            </otherwise>
        </choose>
        LIMIT #{pageSize} OFFSET GREATEST(0, #{offset})
    </select>

    <!-- 댓글 삭제 -->
    <update id="deleteComment" parameterType="map">
        UPDATE recipe_comment
        SET del_yn = 'Y', upt_dt = NOW()
        WHERE comment_id = #{commentId} AND member_id = #{memberId};
    </update>

  <!-- 댓글 내용 또는 레시피 제목으로 검색 -->
<select id="searchByKeyword" resultType="RecipeComment">
    SELECT rc.recipe_id
         , rc.comment_id
         , rc.member_id
         , rc.comment
         , rc.rate
         , rc.reg_dt
         , rc.upt_dt
         , rc.status
         , rc.p_comment_id
         , rc.del_yn
         , mr.title
    FROM recipe_comment rc
    LEFT JOIN member_recipe mr ON rc.recipe_id = mr.recipe_id
    WHERE rc.member_id = #{memberId}
      AND rc.del_yn = 'N'
      <choose>
        <!-- 댓글 내용으로 검색 -->
        <when test="searchType == 'content'">
          AND rc.comment ILIKE '%' || #{keyword} || '%'
        </when>
        <!-- 레시피 제목으로 검색 -->
        <when test="searchType == 'title'">
          AND rc.recipe_id IN (
              SELECT r.recipe_id from member_recipe r WHERE r.title ILIKE '%' || #{keyword} || '%'
          )
        </when>
      </choose>
    ORDER BY
      <choose>
          <when test="sortOption == 'regDt'">rc.reg_dt</when>
          <when test="sortOption == 'recipeId'">rc.recipe_id</when>
          <otherwise>rc.comment_id</otherwise>
      </choose>
    ${sortDirection}
    LIMIT #{pageSize} OFFSET #{offset}
</select>

    <!-- 내가 쓴 게시글 조회 -->
    <select id="getMyBoards" resultType="com.example.cucucook.domain.Board">
    SELECT
    board_id
    ,board_division
    ,member_id
    ,title
    ,contents
    ,board_category_id
    ,reg_dt
    ,udt_dt
    ,status
    ,view_count
    ,p_board_id
    ,user_name
    from BOARD
    where member_id = #{memberId}
    AND board_division = #{boardDivision}
    ORDER BY reg_dt
    LIMIT #{pageSize} OFFSET #{offset}
    </select>


</mapper>
